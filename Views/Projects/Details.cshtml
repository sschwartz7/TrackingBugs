@model TrackingBugs.Models.Project
@inject IBTFileService _BTFileService
@inject IProjectService _ProjectService
@inject IBTRoleService _RoleService

@{
    ViewData["Title"] = "Details";
    BTUser? projectManager = await _ProjectService.GetProjectManagerAsync(Model.Id)!;
}

<h1>Details</h1>

<div>
    <div class="container-fluid">
        <div class="row gy-2">
            <div class="col-md-12 col">
                <div class="row col-cols-2 mt-5 bg-secondary">
                    <div class="card col m-1 p-2">
                        <div class="body">
                            @* Project Name *@
                            <h5>@Model.Name</h5>
                            @* Project Description *@
                            <p>@Model.Description</p>
                            <div class="progress-container progress-info m-b-25">
                                <span class="progress-badge" style="font-size:small">Project Status</span>
                                <div class="progress">
                                    @* Razor code block *@
                                    @*                                     @(var date = Math.Abs(Model.StartDate.Subtract(Model.EndDate))) *@
                                    @*   [Progress Bar code] *@
                                    @*                                     <div class="progress-bar" role="progressbar" aria-valuenow="60" aria-valuemin="0" aria-valuemax="100" style="width: @percent%;">
                                    @* Use Progress Bar code variable here *@
                                    @*                                         <span class="progress-value">100%</span>
                                    </div> *@
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="card col m-1 p-2">
                        <div class="body">
                            <ul class=" list-unstyled basic-list">
                                <li>Start Date: <span class="">@Model.StartDate</span></li>
                                <li>Deadline: <span class="">@Model.EndDate</span></li>
                                <li>Priority: <span class="">@Model.ProjectPriority.Name</span></li>
                                <li>@(Model.Archived == true ? "Inactive" : "Active")</li>


                            </ul>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-4 col mt-5 ">
                <div class="bg-secondary">
                    <div class="card m-1 p-2">
                        <div class="header">
                            <h2>Project Manager</h2>
                            <hr />
                        </div>
                        <div class="body" style="overflow-y:auto;height:300px;">
                            @if(projectManager != null)
                            {
                                
                            <img src="@_BTFileService.ConvertByteArrayToFile(projectManager?.ImageFileData, projectManager?.ImageFileType, DefaultImage.BTUserImage)" alt="Author Images" style="height:40px;width:40px">
                                <p>@(projectManager?.FullName)</p>
                            }else{
                            <span>No Project Manager...</span>
                            <span>Yet</span>
                            }

                        </div>
                    </div>
                </div>
            </div>
            <div class="card-body">
                <h5>Tickets by Priority</h5>
                <p>[Morris Charts]</p>
                <!-- Morris: Donut -->
                <div class="col-md-12">
                    <div id="legend" class="donut-legend" style="font-size:x-small"></div>
                </div>
                <div class="col-md-12">
                    <div class="chart chart-md" id="morrisTicketPriority"></div>
                </div>
            </div>
            <div class="col-md-4 col mt-5 ">
                <div class="bg-secondary">
                    <div class="card m-1 p-2">
                        <div class="header">
                            <h2>Project Team</h2>
                            <hr />
                        </div>
                        <div class="body" style="overflow-y:auto;height:300px;">
                            <ul class="right_chat list-unstyled mb-0">
                                @foreach (BTUser? admin in Model.Members)
                                {

                                    <li>
                                        <div>
                                            <img src="@_BTFileService.ConvertByteArrayToFile(admin?.ImageFileData, admin?.ImageFileType, DefaultImage.BTUserImage)" alt="Author Images" style="height:40px;width:40px">
                                            <span>@admin.FullName</span>
                                            <span>@(string.Join(", ", await _RoleService.GetUserRolesAsync(admin)))</span>
                                        </div>
                                    </li>
                                }
                                <li>
                                    <a asp-action="AssignProjectMembers" asp-route-id="@Model.Id" class="btn btn-primary my-3">Save</a>
                                </li>
                                
                                @* Logic for avatars *@
                            </ul>

                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-4 col mt-5 ">
                <div class="bg-dark">
                    <div class="card m-1 p-2">
                        <div class="header">
                            <h2>Project Activity</h2>
                            <hr />
                        </div>
                        <div class="body" style="overflow-y:auto;height:300px;background-color:antiquewhite">
                            @* Project Activity loop *@
                            @foreach (TicketHistory history in Model.Tickets.SelectMany(t => t.History))
                            {
                                <div class="">

                                    <span class="date" style="font-weight:bold">@history.Created.ToString("dd MMM yyyy")</span>
                                    <h6>@history.Description</h6>
                                    <span>By: <a href="" title="@history.User!.FullName">@history.User.FullName</a></span>
                                    <div class="">
                                        @if (history.Description!.Contains("New Ticket Created"))
                                        {
                                            <p>A ticket was added</p>
                                        }
                                        else if (history.PropertyName!.Equals("ticketComment") || history.PropertyName.Equals("TicketAttachment"))
                                        {
                                            <p>A <b>@history.PropertyName</b> was added.</p>
                                        }
                                        else
                                        {
                                            <p>The ticket <b>@history.PropertyName</b> was edited</p>
                                            <p>@($"Previous {history.PropertyName}: ") <span style="color:red">@history.OldValue</span></p>
                                            <p>@($"Current {history.PropertyName}: ") <span style="color:green">@history.NewValue</span></p>

                                        }
                                    </div>
                                </div>
                            }
                        </div>

                    </div>
                </div>
            </div>
            <div class="col-md-12 col">
                <div class="mt-5 bg-secondary">
                    <div class="card m-1 p-2">
                        <div class="header">
                            <h2>Tickets</h2>
                        </div>
                        <div class="body">
                            <div class="table-responsive" style="overflow-y:auto;height:600px;">
                                <table class="table table-hover">
                                    <thead class="">
                                        <tr>
                                            <th>
                                                Description
                                            </th>
                                            <th>
                                                Title
                                            </th>
                                            <th>
                                                Created
                                            </th>
                                            <th>
                                                Updated
                                            </th>
                                            <th>
                                                Archived
                                            </th>
                                            <th>
                                                Archived
                                            </th>
                                            <th>
                                                Priority
                                            </th>
                                            <th>
                                                Type
                                            </th>
                                            <th>
                                                Status
                                            </th>
                                            <th>
                                                Developer
                                            </th>
                                            <th>
                                                Submitter
                                            </th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        @* Table body *@

                                        @foreach (Ticket item in Model.Tickets)
                                        {
                                            <tr>
                                                <td>
                                                    @Html.DisplayFor(modelItem => item.Description)
                                                </td>
                                                <td>
                                                    @Html.DisplayFor(modelItem => item.Title)
                                                </td>
                                                <td>
                                                    @Html.DisplayFor(modelItem => item.Created)
                                                </td>
                                                <td>
                                                    @Html.DisplayFor(modelItem => item.Updated)
                                                </td>
                                                <td>
                                                    @Html.DisplayFor(modelItem => item.ArchivedByProject)
                                                </td>
                                                <td>
                                                    @Html.DisplayFor(modelItem => item.Archived)
                                                </td>
                                                <td>
                                                    @Html.DisplayFor(modelItem => item.TicketPriority.Id)
                                                </td>
                                                <td>
                                                    @Html.DisplayFor(modelItem => item.TicketType.Id)
                                                </td>
                                                <td>
                                                    @Html.DisplayFor(modelItem => item.TicketStatus.Id)
                                                </td>
                                                <td>
                                                    @Html.DisplayFor(modelItem => item.DeveloperUser.Id)
                                                </td>
                                                <td>
                                                    @Html.DisplayFor(modelItem => item.SubmitterUser.Id)
                                                </td>
                                            </tr>
                                        }
                                    </tbody>
                                </table>
                            </div>

                        </div>
                    </div>

                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts{
@* Morris Donut Chart *@
<script src="//cdnjs.cloudflare.com/ajax/libs/raphael/2.1.0/raphael-min.js"></script>
<script src="//cdnjs.cloudflare.com/ajax/libs/morris.js/0.5.1/morris.min.js"></script>
<script>

    var morrisDonutData = [{
        label: "Low",
        value: @Model.Tickets.Where(t=>t.TicketPriority.Name == nameof(BTTicketPriorities.Low)).Count()
        }, {
        label: "Medium",
        value: @Model.Tickets.Where(t=>t.TicketPriority.Name == nameof(BTTicketPriorities.Medium)).Count()
        }, {
        label: "High",
        value: @Model.Tickets.Where(t=>t.TicketPriority.Name == nameof(BTTicketPriorities.High)).Count()
        }, {
        label: "Urgent",
        value: @Model.Tickets.Where(t=>t.TicketPriority.Name == nameof(BTTicketPriorities.Urgent)).Count()
        }];


    /*
    Morris: Donut
    */
    if ($('#morrisTicketPriority').get(0)) {
        var donutChart = Morris.Donut({
            resize: true,
            element: 'morrisTicketPriority',
            data: morrisDonutData,
            colors: ['#0088cc', '#734ba9', '#E36159', '#ff993b']
        });

        donutChart.options.data.forEach(function (label, i) {
            var legendItem = $('<span></span>').text(label['label'] + ": " + label['value']).prepend('<span>&nbsp;</span>');
            legendItem.find('span')
                .css('backgroundColor', donutChart.options.colors[i])
                .css('width', '20px')
                .css('display', 'inline-block')
                .css('margin', '10px');
            $('#legend').append(legendItem)
        });
    };
</script>
}